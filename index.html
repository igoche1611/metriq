<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metriq Zenith | Decision Intelligence Platform</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zenith: { 900: '#020617', 800: '#0f172a', accent: '#6366f1', glow: '#818cf8', success: '#10b981', danger: '#f43f5e' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>

    <!-- 2. Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 3. Core Engine -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Premium Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
        }
        
        .glass-active {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.1);
        }

        .health-ring { transition: stroke-dashoffset 1s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Privacy Mode Blur */
        .privacy-blur { filter: blur(6px); user-select: none; transition: filter 0.3s; }
        .privacy-blur:hover { filter: blur(0px); }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .apexcharts-tooltip { background: #1e293b !important; border-color: #334155 !important; color: #fff; }
        .apexcharts-tooltip-title { background: #0f172a !important; border-bottom: 1px solid #334155 !important; }
        .apexcharts-text { fill: #94a3b8 !important; }
    </style>
</head>
<body>

<div id="app" class="h-screen flex flex-col relative bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
    
    <!-- AMBIENT LIGHTING -->
    <div class="fixed top-0 left-1/4 w-[800px] h-[500px] bg-indigo-600/10 rounded-full blur-[120px] pointer-events-none animate-pulse"></div>

    <!-- TOP NAVIGATION -->
    <nav class="h-16 glass-panel border-b-0 flex items-center justify-between px-6 z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/30">
                <i class="ph-bold ph-strategy text-white"></i>
            </div>
            <span class="font-bold text-lg tracking-wide bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">METRIQ <span class="font-light text-indigo-400">ZENITH</span></span>
        </div>
        
        <!-- SECTOR INTELLIGENCE SWITCHER -->
        <div class="hidden md:flex items-center gap-2 bg-slate-900/50 p-1 rounded-lg border border-white/5">
            <button @click="setIndustry('Corp')" :class="{'bg-indigo-600 text-white': industry === 'Corp', 'text-slate-400 hover:text-white': industry !== 'Corp'}" class="px-3 py-1 rounded text-xs font-bold transition-all">Corp</button>
            <button @click="setIndustry('SaaS')" :class="{'bg-indigo-600 text-white': industry === 'SaaS', 'text-slate-400 hover:text-white': industry !== 'SaaS'}" class="px-3 py-1 rounded text-xs font-bold transition-all">SaaS</button>
            <button @click="setIndustry('Retail')" :class="{'bg-indigo-600 text-white': industry === 'Retail', 'text-slate-400 hover:text-white': industry !== 'Retail'}" class="px-3 py-1 rounded text-xs font-bold transition-all">Retail</button>
            <button @click="setIndustry('Health')" :class="{'bg-emerald-600 text-white': industry === 'Health', 'text-slate-400 hover:text-white': industry !== 'Health'}" class="px-3 py-1 rounded text-xs font-bold transition-all">Health</button>
            <button @click="setIndustry('Gov')" :class="{'bg-blue-600 text-white': industry === 'Gov', 'text-slate-400 hover:text-white': industry !== 'Gov'}" class="px-3 py-1 rounded text-xs font-bold transition-all">Gov</button>
            <button @click="setIndustry('Finance')" :class="{'bg-indigo-600 text-white': industry === 'Finance', 'text-slate-400 hover:text-white': industry !== 'Finance'}" class="px-3 py-1 rounded text-xs font-bold transition-all">Finance</button>
        </div>

        <div class="flex items-center gap-4">
            <button @click="showUpload = true" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-all border border-white/10 text-xs font-bold uppercase tracking-wider text-slate-300">
                <i class="ph-bold ph-upload-simple"></i> Import
            </button>
            <button @click="exportData" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 transition-all border border-white/10 text-xs font-bold uppercase tracking-wider text-slate-300">
                <i class="ph-bold ph-download-simple"></i> Export Data
            </button>
            <button @click="privacyMode = !privacyMode" class="text-slate-400 hover:text-white transition-colors" title="Toggle Privacy Mode">
                <i :class="privacyMode ? 'ph-bold ph-eye-slash' : 'ph-bold ph-eye'"></i>
            </button>
            <button @click="exportBrief" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 shadow-lg shadow-indigo-500/20 transition-all text-white text-xs font-bold uppercase tracking-wider">
                <i class="ph-bold ph-file-pdf"></i> Report
            </button>
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xs font-bold border border-white/20 shadow-inner">JD</div>
        </div>
    </nav>

    <!-- MAIN WORKSPACE -->
    <div class="flex-1 flex overflow-hidden z-10 relative">
        
        <!-- SIDEBAR -->
        <aside class="w-20 lg:w-64 glass-panel border-r-0 border-white/5 flex flex-col py-6 z-20">
            <div class="space-y-1 px-3">
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 mt-2">Intelligence</p>
                <button @click="view = 'dashboard'" :class="view === 'dashboard' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
                    <i class="ph-duotone ph-chart-polar text-xl"></i> <span class="hidden lg:block font-medium text-sm">Performance Board</span>
                </button>
                <button @click="view = 'actions'" :class="view === 'actions' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group relative">
                    <i class="ph-duotone ph-check-square-offset text-xl"></i> <span class="hidden lg:block font-medium text-sm">Action Plan</span>
                    <span v-if="actionCount > 0" class="absolute right-2 top-2 w-2 h-2 bg-rose-500 rounded-full animate-pulse"></span>
                </button>
                <button @click="view = 'story'" :class="view === 'story' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
                    <i class="ph-duotone ph-book-open-text text-xl"></i> <span class="hidden lg:block font-medium text-sm">Narrative Brief</span>
                </button>
                
                <p class="px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 mt-6">Data Ops</p>
                <button @click="view = 'data_studio'" :class="view === 'data_studio' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
                    <i class="ph-duotone ph-table text-xl"></i> <span class="hidden lg:block font-medium text-sm">Data Studio</span>
                </button>
                <button @click="view = 'metrics'" :class="view === 'metrics' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
                    <i class="ph-duotone ph-function text-xl"></i> <span class="hidden lg:block font-medium text-sm">Metric Builder</span>
                </button>
                <button @click="view = 'audit'" :class="view === 'audit' ? 'glass-active text-indigo-300' : 'text-slate-400 hover:bg-white/5'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all group">
                    <i class="ph-duotone ph-shield-check text-xl"></i> <span class="hidden lg:block font-medium text-sm">Trust & Audit</span>
                </button>
            </div>
            
            <div class="mt-auto px-4">
                <div class="bg-indigo-900/30 border border-indigo-500/20 rounded-xl p-4 animate-pulse">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="ph-fill ph-brain text-indigo-400"></i>
                        <span class="text-xs font-bold text-indigo-200">Always-On Watch</span>
                    </div>
                    <p class="text-[10px] text-slate-400 leading-relaxed">{{ latestInsight }}</p>
                </div>
            </div>
        </aside>

        <!-- CANVAS -->
        <main class="flex-1 overflow-y-auto p-4 lg:p-8 relative scroll-smooth bg-slate-900/50">
            
            <!-- DASHBOARD VIEW -->
            <div v-if="view === 'dashboard'" class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                
                <!-- PERFORMANCE HEALTH ENGINE -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Composite Score -->
                    <div class="glass-panel p-6 rounded-2xl flex items-center justify-between relative overflow-hidden group">
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-500/10 to-transparent"></div>
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Performance Index</p>
                            <h2 class="text-4xl font-bold text-white mt-1" :class="{'privacy-blur': privacyMode}">{{ healthScore }}</h2>
                            <p class="text-xs text-emerald-400 font-bold mt-2 flex items-center gap-1"><i class="ph-bold ph-trend-up"></i> {{ healthTrend }}</p>
                        </div>
                        <div class="relative w-20 h-20 flex items-center justify-center">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-slate-700 stroke-current" stroke-width="8" cx="50" cy="50" r="40" fill="transparent"></circle>
                                <circle class="text-emerald-500 stroke-current health-ring" stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="40" fill="transparent" :stroke-dasharray="251" :stroke-dashoffset="251 - (251 * healthScore / 100)"></circle>
                            </svg>
                            <i class="ph-fill ph-activity text-emerald-500 absolute text-xl"></i>
                        </div>
                    </div>

                    <!-- Automated Insight Cards (The "Decision Layer") -->
                    <div v-for="insight in topInsights" class="glass-panel p-5 rounded-2xl border-l-4 relative group hover:bg-white/5 transition-all" :class="insight.type === 'risk' ? 'border-rose-500' : 'border-indigo-500'">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded" :class="insight.type === 'risk' ? 'bg-rose-500/20 text-rose-300' : 'bg-indigo-500/20 text-indigo-300'">
                                {{ insight.type === 'risk' ? 'Alert' : 'Opportunity' }}
                            </span>
                            <span class="text-[10px] text-slate-500">{{ insight.confidence }}% Conf.</span>
                        </div>
                        <p class="text-sm font-bold text-slate-200 mb-3">{{ insight.message }}</p>
                        <button @click="openActionModal(insight)" class="text-xs font-bold text-white hover:text-indigo-300 flex items-center gap-1 transition-colors">
                            Analyze & Act <i class="ph-bold ph-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- MAIN CHART SECTION with Predictive Layer -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 glass-panel p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="font-bold text-slate-200">{{ industryLabels.metricName }} Trends</h3>
                                <p class="text-xs text-slate-500">Historical vs. AI Forecast (Confidence: High)</p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="runSimulation" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold flex items-center gap-2">
                                    <i class="ph-bold ph-sliders"></i> Simulate Scenario
                                </button>
                            </div>
                        </div>
                        <div id="main-chart" class="min-h-[300px]" :class="{'privacy-blur': privacyMode}"></div>
                    </div>

                    <!-- ACCOUNTABILITY TRACKER -->
                    <div class="glass-panel p-6 rounded-2xl flex flex-col">
                        <h3 class="font-bold text-slate-200 mb-4 flex items-center gap-2"><i class="ph-bold ph-users text-indigo-400"></i> Accountability</h3>
                        <div class="flex-1 space-y-3 overflow-y-auto max-h-[300px] pr-2">
                            <div v-for="action in actionLog" class="p-3 rounded-lg bg-white/5 border border-white/5 hover:border-indigo-500/50 transition-colors cursor-pointer group">
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs font-bold text-indigo-300">{{ action.owner }}</span>
                                    <span class="text-[10px] text-slate-500">{{ action.date }}</span>
                                </div>
                                <p class="text-sm text-slate-300">{{ action.title }}</p>
                                <div class="mt-2 flex items-center gap-2">
                                    <div class="h-1 flex-1 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500" :style="{width: action.progress + '%'}"></div>
                                    </div>
                                    <span class="text-[10px] text-emerald-400">{{ action.roi }} Impact</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-white/5 text-center">
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest">Net Improvement</p>
                            <p class="text-xl font-bold text-emerald-400">+12.5%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: DATA STUDIO (Unified Data Core) -->
            <div v-if="view === 'data_studio'" class="animate-in fade-in slide-in-from-bottom-4">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Data Studio</h2>
                        <p class="text-slate-400 text-sm">Inspect, clean, and validate raw data streams.</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="px-3 py-1.5 bg-slate-800 rounded-lg text-xs font-bold text-slate-300 border border-white/5 flex items-center gap-2">
                            <i class="ph-bold ph-rows"></i> {{ gridData.length }} Rows
                        </div>
                        <div class="px-3 py-1.5 bg-slate-800 rounded-lg text-xs font-bold text-slate-300 border border-white/5 flex items-center gap-2">
                            <i class="ph-bold ph-columns"></i> {{ gridHeaders.length }} Columns
                        </div>
                    </div>
                </div>

                <!-- Sanitization Bar -->
                <div class="mb-6 bg-slate-800/50 border border-white/5 p-4 rounded-xl flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i v-if="missingValueCount > 0" class="ph-fill ph-warning-circle text-rose-500 text-xl"></i>
                        <i v-else class="ph-fill ph-check-circle text-emerald-500 text-xl"></i>
                        <div>
                            <h4 class="font-bold text-sm" :class="missingValueCount > 0 ? 'text-rose-200' : 'text-emerald-200'">
                                {{ missingValueCount > 0 ? 'Data Health Alert' : 'Data is Clean' }}
                            </h4>
                            <p class="text-xs text-slate-400">
                                {{ missingValueCount > 0 ? `Found ${missingValueCount} issues.` : 'No missing values detected.' }}
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="cleanData('remove')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold rounded-lg transition-colors">
                            Remove Rows
                        </button>
                        <button @click="cleanData('impute')" class="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white text-xs font-bold rounded-lg transition-colors">
                            Auto-Fix (Impute)
                        </button>
                    </div>
                </div>

                <!-- Data Grid -->
                <div class="glass-panel rounded-2xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="bg-slate-900/80 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr>
                                <th v-for="header in gridHeaders" :key="header" class="px-6 py-4 whitespace-nowrap">{{ header }}</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <tr v-for="(row, index) in gridData" :key="index" class="hover:bg-white/5 transition-colors group">
                                <td v-for="header in gridHeaders" :key="header" class="px-6 py-3 whitespace-nowrap">
                                    <input 
                                        v-model="gridData[index][header]" 
                                        @change="refreshChartsFromGrid"
                                        class="bg-white/5 border border-white/10 rounded px-2 py-1 w-full text-slate-300 focus:text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors"
                                    >
                                </td>
                                <td class="px-6 py-3 text-right">
                                    <button @click="deleteRow(index)" class="text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <i class="ph-bold ph-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="gridData.length === 0" class="p-12 text-center text-slate-500">
                        <i class="ph-duotone ph-table text-4xl mb-2"></i>
                        <p>No data loaded. Import a CSV file to begin.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: NO-CODE METRIC BUILDER -->
            <div v-if="view === 'metrics'" class="max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4">
                <h2 class="text-2xl font-bold text-white mb-6">No-Code Metric Engine</h2>
                <div class="glass-panel p-8 rounded-2xl">
                    <div class="flex gap-4 items-center mb-6">
                        <div class="bg-indigo-600/20 p-2 rounded text-indigo-400 font-mono text-sm">[ {{ industryLabels.metricName }} ]</div>
                        <i class="ph-bold ph-divide text-slate-500"></i>
                        <div class="bg-purple-600/20 p-2 rounded text-purple-400 font-mono text-sm">[ {{ industry === 'Health' ? 'Staff Count' : 'Cost' }} ]</div>
                        <i class="ph-bold ph-equals text-slate-500"></i>
                        <div class="border-b border-indigo-500 text-white font-bold px-2 py-1">Efficiency Ratio</div>
                    </div>
                    <p class="text-slate-400 text-sm mb-6">Define custom logic using plain English or drag-and-drop variables. The system will back-test this metric against historical data.</p>
                    <button class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold flex items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Create Metric
                    </button>
                </div>
            </div>

            <!-- VIEW: TRUST & AUDIT -->
            <div v-if="view === 'audit'" class="max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4">
                <h2 class="text-2xl font-bold text-white mb-6">Security & Explainability Audit</h2>
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="bg-slate-900/50 text-xs uppercase font-bold text-slate-500">
                            <tr>
                                <th class="px-6 py-4">Timestamp</th>
                                <th class="px-6 py-4">User</th>
                                <th class="px-6 py-4">Action</th>
                                <th class="px-6 py-4">System Logic</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <tr v-for="log in auditLogs" class="hover:bg-white/5">
                                <td class="px-6 py-4 font-mono text-xs text-slate-500">{{ log.time }}</td>
                                <td class="px-6 py-4">{{ log.user }}</td>
                                <td class="px-6 py-4">{{ log.action }}</td>
                                <td class="px-6 py-4 text-xs text-indigo-300">{{ log.logic }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: NARRATIVE (Story) -->
            <div v-if="view === 'story'" class="max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4">
                <div class="glass-panel p-12 rounded-xl bg-slate-100 text-slate-900 shadow-2xl relative">
                    <div class="absolute top-0 left-0 w-full h-2 bg-indigo-600"></div>
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900 mb-2">Performance Strategy Brief</h1>
                            <p class="text-slate-500">Generated on {{ new Date().toLocaleDateString() }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-indigo-600">CONFIDENTIAL</p>
                            <p class="text-xs text-slate-400">Metriq Zenith AI</p>
                        </div>
                    </div>

                    <div class="prose prose-slate max-w-none">
                        <h3>1. Executive Summary</h3>
                        <p>
                            Based on the current trajectory, the organization is demonstrating a <strong class="text-emerald-600">stable performance signal (Index: {{ healthScore }})</strong>. 
                            {{ industryLabels.metricName }} is projected to vary by 12% if current mitigation strategies are maintained.
                        </p>

                        <h3>2. Critical Risks & Anomalies</h3>
                        <ul>
                            <li v-for="risk in topInsights.filter(i => i.type === 'risk')" class="text-rose-700 font-medium">
                                {{ risk.message }} (Confidence: {{ risk.confidence }}%)
                            </li>
                        </ul>

                        <h3>3. Strategic Recommendations</h3>
                        <p>To maximize the current opportunity window, the Decision Engine recommends:</p>
                        <div class="not-prose grid gap-4 my-4">
                            <div class="p-4 bg-white border border-slate-200 shadow-sm rounded-lg border-l-4 border-indigo-600">
                                <h4 class="font-bold text-indigo-900">Action: {{ topInsights[0]?.recommendation || 'Optimize Allocation' }}</h4>
                                <p class="text-sm text-slate-600">Root Cause: {{ topInsights[0]?.rootCause || 'Variance in baseline metrics.' }}</p>
                                <p class="text-sm text-slate-600 font-bold mt-1">Expected Impact: {{ topInsights[0]?.impact || 'Stabilization' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- NEURAL COMMAND BAR (NLP ENGINE) -->
        <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 w-[90%] max-w-2xl z-30">
            <div class="glass-panel bg-slate-900/90 rounded-2xl p-2 flex items-center gap-4 shadow-2xl shadow-indigo-900/50 transition-all focus-within:scale-105 ring-1 ring-white/10 focus-within:ring-indigo-500">
                <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center shrink-0 animate-pulse">
                    <i v-if="isThinking" class="ph-bold ph-spinner animate-spin text-white text-xl"></i>
                    <i v-else class="ph-bold ph-sparkle text-white text-xl"></i>
                </div>
                <input 
                    type="text" 
                    v-model="prompt"
                    @keyup.enter="handleAI"
                    placeholder="Ask Zenith... (e.g. 'Generate new forecast')" 
                    class="bg-transparent border-none w-full text-lg placeholder-slate-500 focus:ring-0 text-white h-12 outline-none"
                >
                <div class="hidden md:block pr-4">
                    <button @click="fillPrompt" class="text-xs bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded hover:bg-indigo-500 hover:text-white transition-colors">
                        Inspire Me
                    </button>
                </div>
                <div class="hidden md:block pr-4">
                    <i class="ph-bold ph-microphone text-slate-500 hover:text-white cursor-pointer"></i>
                </div>
            </div>
        </div>

    </div>

    <!-- FILE UPLOAD MODAL (Loading State Enabled) -->
    <div v-if="showUpload" class="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in-95">
        <div class="glass-panel p-8 rounded-3xl max-w-lg w-full text-center relative border border-white/10">
            
            <!-- CLOSE BUTTON (Hidden when loading) -->
            <button v-if="!isUploading" @click="showUpload = false" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
            
            <!-- LOADING STATE -->
            <div v-if="isUploading" class="flex flex-col items-center justify-center py-8">
                <i class="ph-bold ph-spinner animate-spin text-5xl text-indigo-400 mb-6"></i>
                <h3 class="text-xl font-bold text-white tracking-wide">Ingesting Data Stream</h3>
                <p class="text-slate-400 text-sm mt-3 animate-pulse">Running normalization engine & validating schema...</p>
            </div>

            <!-- DEFAULT UPLOAD STATE -->
            <div v-else>
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 border border-white/10">
                    <i class="ph-duotone ph-cloud-arrow-up text-4xl text-indigo-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Connect Data Source</h2>
                <p class="text-slate-400 mb-8">Upload CSV, JSON, or TSV files to feed the Decision Engine.</p>
                <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept=".csv,.json,.tsv,.txt">
                <button @click="$refs.fileInput.click()" class="w-full py-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                    <i class="ph-bold ph-upload-simple"></i> Select File
                </button>
                <p class="mt-4 text-xs text-slate-500 font-mono">AUTO-NORMALIZATION ACTIVE</p>
            </div>
        </div>
    </div>

    <!-- DECISION INTELLIGENCE MODAL (Root Cause & Action) -->
    <div v-if="selectedInsight" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in zoom-in-95">
        <div class="glass-panel p-8 rounded-3xl max-w-xl w-full relative border border-indigo-500/30 shadow-2xl shadow-indigo-500/20">
            <button @click="selectedInsight = null" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button>
            
            <div class="mb-6">
                <span class="text-[10px] font-bold uppercase tracking-wider bg-indigo-500/20 text-indigo-300 px-2 py-1 rounded mb-2 inline-block">Decision Intelligence</span>
                <h2 class="text-2xl font-bold text-white">{{ selectedInsight.message }}</h2>
            </div>

            <div class="space-y-6 mb-8">
                <!-- Root Cause -->
                <div class="flex gap-4">
                    <div class="w-1 bg-indigo-500 rounded-full"></div>
                    <div>
                        <h4 class="font-bold text-indigo-300 text-sm mb-1">Root Cause Analysis</h4>
                        <p class="text-slate-300 text-sm">{{ selectedInsight.rootCause }}</p>
                    </div>
                </div>

                <!-- Recommendation -->
                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                    <h4 class="font-bold text-white text-sm mb-1"><i class="ph-fill ph-lightbulb text-yellow-400 mr-2"></i>Recommended Action</h4>
                    <p class="text-slate-300 text-sm">{{ selectedInsight.recommendation }}</p>
                </div>

                <!-- Impact Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-white/5 rounded-xl text-center">
                        <p class="text-xs text-slate-500 font-bold uppercase">Expected Impact</p>
                        <p class="text-lg font-bold text-emerald-400">{{ selectedInsight.impact }}</p>
                    </div>
                    <div class="p-4 bg-white/5 rounded-xl text-center">
                        <p class="text-xs text-slate-500 font-bold uppercase">AI Confidence</p>
                        <p class="text-lg font-bold text-white">{{ selectedInsight.confidence }}%</p>
                    </div>
                </div>
            </div>

            <!-- Accountability Input -->
            <div class="mb-4">
                <label class="text-xs text-slate-500 font-bold uppercase mb-2 block">Assign Owner</label>
                <select class="w-full bg-slate-900 border border-slate-700 text-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none">
                    <option>Me (Current User)</option>
                    <option>Department Lead</option>
                    <option>External Consultant</option>
                </select>
            </div>

            <button @click="commitAction" class="w-full py-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold shadow-lg transition-all flex items-center justify-center gap-2">
                <i class="ph-bold ph-check-square"></i> Commit & Track Result
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                view: 'dashboard',
                industry: 'SaaS',
                privacyMode: false,
                showUpload: false,
                isUploading: false,
                isThinking: false,
                prompt: '',
                healthScore: 78,
                healthTrend: 'Stable',
                selectedInsight: null,
                complexPrompts: [
                    "Generate a multi-dimensional performance dashboard correlating monthly revenue with operational efficiency, including a 6-month predictive forecast.",
                    "Analyze Q3 customer acquisition costs against lifetime value, identify churn risk factors in the enterprise segment.",
                    "Create a cross-sector impact report evaluating the correlation between employee engagement scores and productivity output."
                ],
                
                // UNIFIED DATA CORE (The Single Source of Truth)
                gridHeaders: ['Month', 'Metric A', 'Metric B'],
                gridData: [
                    { Month: 'Jan', 'Metric A': 120, 'Metric B': 90 },
                    { Month: 'Feb', 'Metric A': 140, 'Metric B': 95 },
                    { Month: 'Mar', 'Metric A': 115, 'Metric B': 110 }
                ],
                
                topInsights: [],
                auditLogs: [],
                actionLog: [],

                // CHART CONFIG (Static)
                chartOptions: {
                    chart: { type: 'area', height: 350, toolbar: { show: false }, background: 'transparent', animations: { enabled: true } },
                    colors: ['#6366f1', '#10b981', '#f43f5e', '#fbbf24', '#06b6d4'],
                    stroke: { curve: 'smooth', width: 3 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.1 } },
                    theme: { mode: 'dark' },
                    grid: { borderColor: '#334155', strokeDashArray: 4 },
                    dataLabels: { enabled: false },
                    xaxis: { labels: { style: { colors: '#94a3b8' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { style: { colors: '#94a3b8' } } }
                }
            }
        },
        computed: {
            latestInsight() {
                return this.topInsights.length > 0 ? this.topInsights[0].message : 'Scanning data streams...';
            },
            actionCount() {
                return this.actionLog.filter(a => a.progress < 100).length;
            },
            industryLabels() {
                if (this.industry === 'Retail') return { metricName: 'Gross Merchandise Value (GMV)', unit: '$' };
                if (this.industry === 'Finance') return { metricName: 'Assets Under Management', unit: '$' };
                if (this.industry === 'Health') return { metricName: 'Patient Recovery Rate', unit: '%' };
                if (this.industry === 'Gov') return { metricName: 'Budget Utilization', unit: '%' };
                if (this.industry === 'Corp') return { metricName: 'EBITDA Margin', unit: '%' };
                return { metricName: 'Annual Recurring Revenue (ARR)', unit: '$' };
            },
            missingValueCount() {
                let count = 0;
                this.gridData.forEach(row => {
                    Object.values(row).forEach(val => {
                        if (val === '' || val === null || val === undefined) count++;
                    });
                });
                return count;
            }
        },
        watch: {
            // THE WATCHER: Anytime gridData changes (via AI, Upload, or Sector), update the chart
            gridData: {
                handler() {
                    // Update Charts whenever Grid Data changes
                    this.updateChartFromGrid();
                },
                deep: true
            },
            industry() {
                this.generateSectorData();
            }
        },
        mounted() {
            this.setIndustry('SaaS');
            this.$nextTick(() => {
                this.initChart();
            });
        },
        methods: {
            triggerUpload() {
                this.$refs.fileInput.click();
            },
            setIndustry(type) {
                this.industry = type;
                this.generateSectorData();
            },
            // Generates new GRID DATA based on sector, triggering the watcher
            generateSectorData() {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                let dataA = [], dataB = [];
                
                // MOCK GENERATOR
                if(this.industry === 'SaaS') {
                    this.gridHeaders = ['Month', 'Actual ARR', 'AI Forecast'];
                    dataA = [31, 40, 28, 51, 42, 68];
                    dataB = [33, 42, 35, 55, 60, 75];
                    this.topInsights = [{ type: 'risk', message: 'Churn rate spiked 15%', rootCause: 'Competitor Launch', recommendation: 'Offer loyalty discount.', impact: 'Save $45k ARR', confidence: 92 }];
                } else if(this.industry === 'Health') {
                    this.gridHeaders = ['Month', 'Recovery Rate', 'Target'];
                    dataA = [85, 87, 84, 88, 86, 89];
                    dataB = [86, 88, 89, 90, 91, 92];
                    this.topInsights = [{ type: 'risk', message: 'ER Wait Time Exceeds Baseline', rootCause: 'Viral case surge.', recommendation: 'Activate overflow protocol.', impact: '-25% Wait Time', confidence: 95 }];
                } else {
                    // Default / Corp
                    this.gridHeaders = ['Month', 'Revenue', 'Expenses'];
                    dataA = [100, 120, 110, 140, 160, 180];
                    dataB = [80, 90, 85, 95, 100, 110];
                    this.topInsights = [{ type: 'opp', message: 'Efficiency Gain Detected', rootCause: 'Workflow Automation', recommendation: 'Scale to other depts.', impact: '+15% Output', confidence: 89 }];
                }

                this.gridData = months.map((m, i) => {
                    let row = {};
                    row[this.gridHeaders[0]] = m;
                    row[this.gridHeaders[1]] = dataA[i];
                    row[this.gridHeaders[2]] = dataB[i];
                    return row;
                });
            },
            initChart() {
                if(this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new ApexCharts(document.querySelector("#main-chart"), this.chartOptions);
                this.chartInstance.render();
                this.updateChartFromGrid();
            },
            updateChartFromGrid() {
                if (!this.gridData.length || !this.chartInstance) return;
                
                const xKey = this.gridHeaders[0]; // Assume first col is X
                const yKeys = this.gridHeaders.slice(1);
                
                const categories = this.gridData.map(r => r[xKey]);
                const series = yKeys.map(key => ({
                    name: key,
                    data: this.gridData.map(r => Number(r[key]) || 0)
                }));

                this.chartInstance.updateOptions({ xaxis: { categories } });
                this.chartInstance.updateSeries(series);
            },
            fillPrompt() {
                const randomPrompt = this.complexPrompts[Math.floor(Math.random() * this.complexPrompts.length)];
                this.prompt = randomPrompt;
            },
            handleAI() {
                if(!this.prompt) return;
                this.isThinking = true;
                
                setTimeout(() => {
                    this.isThinking = false;
                    const p = this.prompt.toLowerCase();
                    
                    // AI LOGIC: UPDATES GRID DATA DIRECTLY
                    if (p.includes('generate') || p.includes('dashboard')) {
                        // Create fake "New" data
                        this.view = 'dashboard';
                        this.healthScore = 95;
                        this.gridHeaders = ['Month', 'New Metric A', 'New Metric B'];
                        this.gridData = [
                            { Month: 'Q1', 'New Metric A': 500, 'New Metric B': 200 },
                            { Month: 'Q2', 'New Metric A': 750, 'New Metric B': 400 },
                            { Month: 'Q3', 'New Metric A': 1000, 'New Metric B': 600 }
                        ];
                        this.auditLogs.unshift({ time: 'Just now', user: 'Zenith AI', action: 'Dashboard Generation', logic: 'NLP Prompt Processing' });
                        this.prompt = '';
                    } else if(p.includes('simulate')) {
                        this.runSimulation();
                        this.prompt = '';
                    } else {
                        alert(`Zenith AI: I have processed your request. See Action Plan for details.`);
                        this.prompt = '';
                    }
                }, 1200);
            },
            openActionModal(insight) {
                this.selectedInsight = insight;
            },
            commitAction() {
                this.actionLog.unshift({
                    title: 'Action: ' + this.selectedInsight.recommendation,
                    owner: 'Current User',
                    category: 'Decision Engine',
                    date: 'Just now',
                    progress: 0,
                    roi: 'Tracking...'
                });
                this.auditLogs.unshift({
                    time: 'Just now',
                    user: 'Current User',
                    action: 'Decision Commited',
                    logic: `Adopted AI Rec: ${this.selectedInsight.recommendation}`
                });
                this.selectedInsight = null;
                this.view = 'actions';
            },
            exportBrief() {
                alert("Generating PDF...");
            },
            exportData() {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += this.gridHeaders.join(",") + "\n";
                this.gridData.forEach(row => {
                    csvContent += Object.values(row).join(",") + "\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "metriq_data_export.csv");
                document.body.appendChild(link);
                link.click();
                link.remove();
            },
            runSimulation() {
                // Modify existing Grid Data to simulate +15%
                const targetKey = this.gridHeaders[1]; // Pick first metric
                this.gridData = this.gridData.map(row => ({
                    ...row,
                    [targetKey]: Math.round(Number(row[targetKey]) * 1.15)
                }));
                this.healthScore = 88;
                this.auditLogs.unshift({ time: 'Just now', user: 'Current User', action: 'Simulation', logic: '+15% Efficiency Scenario' });
            },
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // NO LOADING STATE VISIBLE TO PREVENT HANGING
                // Process immediately
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.trim().split('\n').filter(l => l);
                        if(lines.length < 2) throw new Error("Invalid CSV");
                        
                        const headers = lines[0].split(',').map(h => h.trim());
                        const newData = [];
                        
                        for(let i=1; i<lines.length; i++) {
                            const row = lines[i].split(',');
                            let obj = {};
                            headers.forEach((h, idx) => {
                                // Simple cleanup
                                let val = row[idx] ? row[idx].replace('\r', '') : '';
                                obj[h] = val;
                            });
                            newData.push(obj);
                        }
                        
                        // UPDATE SINGLE SOURCE OF TRUTH
                        this.gridHeaders = headers;
                        this.gridData = newData;
                        
                        // GENERATE NEW INSIGHTS BASED ON DATA
                        const firstMetric = headers[1];
                        const lastVal = Number(newData[newData.length-1][firstMetric]);
                        const firstVal = Number(newData[0][firstMetric]);
                        const growth = ((lastVal - firstVal) / firstVal * 100).toFixed(1);
                        
                        this.healthScore = growth > 0 ? 85 : 45;
                        this.healthTrend = growth > 0 ? 'Positive Growth' : 'Declining';
                        this.topInsights = [
                            { type: growth > 0 ? 'opp' : 'risk', message: `Detected ${growth}% variance in ${firstMetric}`, rootCause: 'Imported Data Trend', recommendation: 'Review anomalies.', impact: 'High', confidence: 90 }
                        ];

                        console.log("File loaded.");
                        if (this.$refs.fileInput) this.$refs.fileInput.value = ''; 
                    } catch(err) {
                        alert("Error: " + err.message);
                    }
                };
                reader.readAsText(file);
            },
            cleanData(action) {
                if (action === 'remove') {
                    this.gridData = this.gridData.filter(row => Object.values(row).every(v => v !== '' && v !== null && v !== undefined));
                } else {
                    // Impute
                    this.gridHeaders.forEach(h => {
                       // Calc Avg
                       const nums = this.gridData.map(r => parseFloat(r[h])).filter(n => !isNaN(n));
                       const avg = nums.length ? Math.round(nums.reduce((a,b)=>a+b,0)/nums.length) : 0;
                       this.gridData.forEach(r => {
                           if(r[h] === '' || r[h] == null) r[h] = avg;
                       });
                    });
                }
            },
            deleteRow(index) {
                this.gridData.splice(index, 1);
            },
            refreshChartsFromGrid() {
                // Triggered by input @change, essentially just forces update via watcher
                this.updateChartFromGrid();
            }
        }
    }).mount('#app');
</script>

</body>
</html>
