<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metriq AI | Enterprise Analytics</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core Engine) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Translates React for Browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Firebase SDKs (Database) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #f8fafc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR OWN FIREBASE CONFIG FROM CONSOLE.FIREBASE.GOOGLE.COM
        // If you leave this as is, it might fail if the demo project is deleted.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase safely
        if (!firebase.apps.length) {
            try {
                // If user hasn't set up config, we mock it to prevent crash for UI demo
                if(firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                   console.warn("Firebase config missing. Using local mock mode.");
                } else {
                   firebase.initializeApp(firebaseConfig);
                }
            } catch(e) { console.error(e); }
        }

        const auth = firebase.apps.length ? firebase.auth() : null;
        const db = firebase.apps.length ? firebase.firestore() : null;

        const { useState, useEffect, useRef } = React;

        // --- ICONS (SVG MAPPING) ---
        // We use raw SVGs here to avoid external library dependency issues
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Menu: <path d="M4 6h16M4 12h16M4 18h16" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                UploadCloud: <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" />,
                CheckCircle2: <circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" />,
                AlertCircle: <circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" />,
                Layout: <rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><line x1="3" x2="21" y1="9" y2="9" /><line x1="9" x2="9" y1="21" y2="9" />,
                Sliders: <line x1="4" x2="4" y1="21" y2="14" /><line x1="4" x2="4" y1="10" y2="3" /><line x1="12" x2="12" y1="21" y2="12" /><line x1="12" x2="12" y1="8" y2="3" /><line x1="20" x2="20" y1="21" y2="16" /><line x1="20" x2="20" y1="12" y2="3" /><line x1="2" x2="6" y1="14" y2="14" /><line x1="10" x2="14" y1="8" y2="8" /><line x1="18" x2="22" y1="16" y2="16" />,
                Crown: <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14" />,
                Trash2: <path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" />,
                Sparkles: <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" />,
                RefreshCw: <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" />,
                ArrowRight: <path d="M5 12h14" /><path d="m12 5 7 7-7 7" />,
            };
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- CHART COMPONENT ---
        const ChartWidget = ({ type, data, xKey, yKey, color = "#3b82f6", simulation }) => {
            if (!data || data.length === 0) return <div className="h-full flex items-center justify-center text-slate-300">No Data</div>;

            const processValue = (val) => {
                let num = Number(val);
                if (simulation) {
                    num = num * (1 + (simulation.revenueMod / 100));
                    num = num * (1 - (simulation.costMod / 100));
                }
                return num;
            };

            const values = data.map(d => processValue(d[yKey]));
            const max = Math.max(...values, 1) * 1.1;
            const min = Math.min(...values, 0) * 0.9;
            const h = 160;
            const w = 400;

            if (type === 'kpi') {
                const total = values.reduce((a,b) => a+b, 0);
                return (
                    <div className="flex flex-col items-center justify-center h-full py-4">
                        <span className="text-4xl font-bold text-slate-800">
                            {total.toLocaleString(undefined, { maximumFractionDigits: 0, notation: "compact" })}
                        </span>
                        <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mt-2">Total {yKey}</span>
                        {simulation && (simulation.revenueMod !== 0 || simulation.costMod !== 0) && (
                            <span className="text-[10px] font-bold text-emerald-500 bg-emerald-50 px-2 py-1 rounded-full mt-2">Simulated</span>
                        )}
                    </div>
                );
            }

            const pointsStr = data.map((d, i) => {
                const x = (i / (data.length - 1 || 1)) * w;
                const y = h - ((processValue(d[yKey]) - min) / (max - min || 1)) * h;
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="w-full h-full relative group">
                    <svg viewBox={`0 0 ${w} ${h}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
                        {type === 'area' && (
                            <g>
                                <defs>
                                    <linearGradient id={`grad-${yKey}`} x1="0" x2="0" y1="0" y2="1">
                                        <stop offset="0%" stopColor={color} stopOpacity="0.2"/>
                                        <stop offset="100%" stopColor={color} stopOpacity="0"/>
                                    </linearGradient>
                                </defs>
                                <polygon points={`0,${h} ${pointsStr} ${w},${h}`} fill={`url(#grad-${yKey})`} />
                            </g>
                        )}
                        {(type === 'line' || type === 'area') && (
                           <polyline points={pointsStr} fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
                        )}
                        {type === 'bar' && data.map((d, i) => {
                           const barH = ((processValue(d[yKey]) - min) / (max - min || 1)) * h;
                           const barW = (w / data.length) * 0.6;
                           const x = (i / data.length) * w + (barW/2);
                           return <rect key={i} x={x} y={h - barH} width={barW} height={barH} fill={color} rx="2" />
                        })}
                    </svg>
                </div>
            );
        };

        const DEFAULT_CSV = "Month,Revenue,Expenses,Users,Churn\nJan,12000,8000,500,20\nFeb,15000,8500,600,18\nMar,11000,7500,450,25\nApr,18000,9200,800,15\nMay,22000,10500,1000,12\nJun,19000,9800,1100,14\nJul,26000,12000,1300,10\nAug,29000,13000,1450,9\nSep,31000,14000,1600,8\nOct,28000,13500,1550,11\nNov,35000,15000,1800,7\nDec,42000,18000,2100,5";

        // --- MAIN APPLICATION ---
        function App() {
            const [user, setUser] = useState(null);
            const [isPro, setIsPro] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [dataText, setDataText] = useState(DEFAULT_CSV);
            const [dataset, setDataset] = useState([]);
            const [cols, setCols] = useState({ num: [], cat: [] });
            const [prompt, setPrompt] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [showSimulator, setShowSimulator] = useState(false);
            const [simulation, setSimulation] = useState({ revenueMod: 0, costMod: 0 });
            const [widgets, setWidgets] = useState([
                { id: 1, type: 'area', xKey: 'Month', yKey: 'Revenue', title: 'Revenue Trend', width: 'col-span-2' },
                { id: 2, type: 'kpi', xKey: 'Month', yKey: 'Revenue', title: 'Total Revenue', width: 'col-span-1' },
                { id: 3, type: 'bar', xKey: 'Month', yKey: 'Users', title: 'User Growth', width: 'col-span-1' },
            ]);
            
            const fileInputRef = useRef(null);

            // Auth Setup
            useEffect(() => {
                if(auth) {
                    auth.onAuthStateChanged((u) => {
                        if (u) {
                            setUser(u);
                            // Real app: check DB. Demo app: Mock pro if needed
                            // For Demo purposes, we default to PRO enabled so user can see features immediately
                            setIsPro(true); 
                        } else {
                            auth.signInAnonymously();
                        }
                    });
                } else {
                    // Fallback for no firebase config
                    setIsPro(true);
                }
            }, []);

            // Data Parsing
            useEffect(() => {
                const lines = dataText.trim().split('\n');
                if (lines.length > 1) {
                    const headers = lines[0].split(',').map(h => h.trim());
                    const parsed = lines.slice(1).map(line => {
                        const vals = line.split(',');
                        const obj = {};
                        headers.forEach((h, i) => {
                            let v = vals[i]?.trim();
                            if (v && !isNaN(Number(v))) v = Number(v);
                            obj[h] = v;
                        });
                        return obj;
                    });
                    setDataset(parsed);
                    const keys = Object.keys(parsed[0]);
                    const num = keys.filter(k => typeof parsed[0][k] === 'number');
                    const cat = keys.filter(k => !num.includes(k));
                    setCols({ num, cat });
                }
            }, [dataText]);

            const handlePromptSubmit = (e) => {
                e.preventDefault();
                if (!prompt.trim()) return;
                setIsGenerating(true);
                
                setTimeout(() => {
                    const p = prompt.toLowerCase();
                    let newWidgets = [];
                    const xKey = cols.cat[0] || 'id';

                    if (p.includes('sales') || p.includes('revenue')) {
                        newWidgets.push({ id: Date.now(), type: 'area', xKey, yKey: cols.num.find(c => c.toLowerCase().includes('rev') || c.toLowerCase().includes('sales')) || cols.num[0], title: 'Revenue Overview', width: 'col-span-2' });
                    } else if (p.includes('growth') || p.includes('trend')) {
                        cols.num.forEach((col, idx) => {
                            if(idx < 2) newWidgets.push({ id: Date.now()+idx, type: 'line', xKey, yKey: col, title: `${col} Trend`, width: 'col-span-1' });
                        });
                    } else {
                        newWidgets = [{ id: Date.now(), type: 'bar', xKey, yKey: cols.num[0], title: `Analysis of ${cols.num[0]}`, width: 'col-span-2' }];
                    }
                    
                    setWidgets(prev => [...newWidgets, ...prev]);
                    setIsGenerating(false);
                    setPrompt('');
                }, 800);
            };

            const handleUpgrade = () => {
                setIsPro(true);
                alert("Enterprise Features Unlocked (Demo Mode)");
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 flex flex-col md:flex-row relative overflow-x-hidden">
                    
                    {/* MOBILE HEADER */}
                    <div className="md:hidden bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-white shadow-sm">M</div>
                            <span className="font-bold text-lg tracking-tight">Metriq</span>
                        </div>
                        <button onClick={() => setMobileMenuOpen(true)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                            <Icon name="Menu" size={24} />
                        </button>
                    </div>

                    {/* MOBILE SIDEBAR */}
                    <div className={`fixed inset-0 z-50 transform transition-transform duration-300 md:relative md:transform-none md:flex md:w-64 md:h-screen md:bg-slate-900 md:text-slate-300 md:flex-col md:sticky md:top-0 ${mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="absolute inset-0 bg-slate-900 text-slate-300 flex flex-col h-full shadow-2xl">
                            <div className="p-6 flex items-center justify-between">
                                <div className="flex items-center gap-2 text-white">
                                    <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-lg">M</div>
                                    <span className="font-bold text-xl tracking-tight">Metriq AI</span>
                                </div>
                                <button onClick={() => setMobileMenuOpen(false)} className="md:hidden p-1 text-slate-400">
                                    <Icon name="X" size={24} />
                                </button>
                            </div>

                            <nav className="flex-1 px-4 space-y-2 mt-4">
                                <button onClick={() => setMobileMenuOpen(false)} className="w-full flex items-center gap-3 px-4 py-4 rounded-xl bg-blue-600 text-white shadow-lg shadow-blue-900/50">
                                    <Icon name="Layout" size={20} />
                                    <span className="font-medium">Dashboard</span>
                                </button>
                                <button onClick={() => { setShowSimulator(!showSimulator); setMobileMenuOpen(false); }} className="w-full flex items-center gap-3 px-4 py-4 rounded-xl hover:bg-slate-800 text-slate-300 transition-colors">
                                    <Icon name="Sliders" size={20} />
                                    <div className="flex flex-col items-start text-left">
                                        <span className="font-medium">Simulator</span>
                                        {isPro ? <span className="text-[10px] text-indigo-400">Active</span> : <span className="text-[10px] text-slate-500">Locked</span>}
                                    </div>
                                </button>
                            </nav>
                            
                            {!isPro && (
                                <div className="p-4 mb-4">
                                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-4 text-white text-center">
                                        <Icon name="Crown" className="mx-auto mb-2 text-yellow-300" size={20} />
                                        <p className="font-bold text-sm">Enterprise Tier</p>
                                        <button onClick={handleUpgrade} className="mt-3 w-full bg-white text-indigo-600 text-xs font-bold py-3 rounded-lg hover:bg-indigo-50">
                                            Unlock Simulator
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={() => setMobileMenuOpen(false)}></div>}

                    {/* MAIN CONTENT */}
                    <main className="flex-1 overflow-y-auto h-[calc(100vh-60px)] md:h-screen relative">
                        
                        {/* HEADER */}
                        <header className="hidden md:flex bg-white/80 backdrop-blur-md border-b border-slate-200 px-8 py-4 sticky top-0 z-20 justify-between items-center">
                            <div className="flex items-center gap-4 text-sm text-slate-500">
                                <span className="font-mono bg-slate-100 px-2 py-1 rounded">{dataset.length} Rows</span>
                                <span className="flex items-center gap-1"><Icon name="CheckCircle2" size={14} className="text-emerald-500"/> Healthy</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-100 rounded-lg">
                                    <Icon name="UploadCloud" size={16} /> Import
                                </button>
                                <input type="file" ref={fileInputRef} onChange={(e) => {
                                    const r = new FileReader();
                                    r.onload = (ev) => setDataText(ev.target.result);
                                    if(e.target.files[0]) r.readAsText(e.target.files[0]);
                                }} className="hidden" />
                            </div>
                        </header>

                        {/* AI COMMAND */}
                        <div className="px-4 md:px-8 pt-6 pb-4">
                            <form onSubmit={handlePromptSubmit} className="relative w-full group">
                                <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                    {isGenerating ? <Icon name="RefreshCw" size={20} className="text-blue-500 animate-spin"/> : <Icon name="Sparkles" size={20} className="text-blue-500"/>}
                                </div>
                                <input 
                                    type="text" 
                                    value={prompt}
                                    onChange={(e) => setPrompt(e.target.value)}
                                    placeholder="Ask AI to build a widget... (e.g. 'Show revenue trend')" 
                                    className="w-full pl-12 pr-12 py-3 md:py-4 text-base md:text-lg bg-white border-2 border-slate-200 rounded-2xl shadow-sm focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400"
                                />
                                <button type="submit" className="absolute right-2 top-2 bottom-2 bg-blue-600 text-white px-3 md:px-4 rounded-xl font-bold hover:bg-blue-700 transition-colors">
                                    <Icon name="ArrowRight" size={20} />
                                </button>
                            </form>
                            
                            <div className="mt-3 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {["Show KPI", "Sales vs Cost", "User Growth"].map(txt => (
                                    <button key={txt} onClick={() => setPrompt(txt)} className="text-xs font-medium bg-white border border-slate-200 px-3 py-2 rounded-full text-slate-500 active:bg-blue-50 active:border-blue-300 active:text-blue-600 whitespace-nowrap transition-colors shadow-sm">
                                        {txt}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* SIMULATOR */}
                        {showSimulator && isPro && (
                            <div className="mx-4 md:mx-8 mb-6 p-5 bg-indigo-50 border border-indigo-100 rounded-2xl animate-fade-in">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="font-bold text-indigo-900 flex items-center gap-2"><Icon name="Sliders" size={18}/> Simulator</h3>
                                    <button onClick={() => setSimulation({ revenueMod: 0, costMod: 0 })} className="text-xs font-bold text-indigo-600">Reset</button>
                                </div>
                                <div className="space-y-6 md:space-y-0 md:grid md:grid-cols-2 md:gap-8">
                                    <div>
                                        <label className="flex justify-between text-sm font-bold text-indigo-800 mb-2">
                                            <span>Price Impact</span>
                                            <span className="bg-white px-2 rounded text-indigo-600">{simulation.revenueMod > 0 ? '+' : ''}{simulation.revenueMod}%</span>
                                        </label>
                                        <input type="range" min="-50" max="50" value={simulation.revenueMod} onChange={(e) => setSimulation({...simulation, revenueMod: Number(e.target.value)})} className="w-full h-4 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    </div>
                                    <div>
                                        <label className="flex justify-between text-sm font-bold text-indigo-800 mb-2">
                                            <span>Efficiency</span>
                                            <span className="bg-white px-2 rounded text-indigo-600">{simulation.costMod > 0 ? '+' : ''}{simulation.costMod}%</span>
                                        </label>
                                        <input type="range" min="-50" max="50" value={simulation.costMod} onChange={(e) => setSimulation({...simulation, costMod: Number(e.target.value)})} className="w-full h-4 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* WIDGET GRID */}
                        <div className="p-4 md:p-8 max-w-7xl mx-auto pb-20">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                {widgets.map(widget => (
                                    <div key={widget.id} className={`bg-white p-5 rounded-2xl shadow-sm border border-slate-200 ${widget.width === 'col-span-2' ? 'md:col-span-2' : ''}`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <h3 className="font-bold text-slate-700 text-sm md:text-base">{widget.title}</h3>
                                            <button onClick={() => setWidgets(widgets.filter(w => w.id !== widget.id))} className="text-slate-300 hover:text-red-400 p-1">
                                                <Icon name="Trash2" size={16} />
                                            </button>
                                        </div>
                                        <div className="h-48 md:h-40">
                                            <ChartWidget type={widget.type} data={dataset} xKey={widget.xKey} yKey={widget.yKey} simulation={showSimulator && isPro ? simulation : null} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* MOBILE FAB */}
                        <button onClick={() => fileInputRef.current.click()} className="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-xl shadow-blue-600/40 z-30 active:scale-90 transition-transform">
                            <Icon name="UploadCloud" size={24} />
                        </button>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

